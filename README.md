# MVP - Notes Manager

Менеджер заметок на Python с использованием PySide6 для работы с иерархическими заметками, rich-text редактированием и автоматическим сохранением содержимого буфера обмена.

## Основные возможности

### Структура заметок
- **Иерархическое дерево заметок** с неограниченной вложенностью
- **Три корневые ветки:**
  - "Текущие" - основные рабочие заметки
  - "Буфер обмена" - автоматическое сохранение истории буфера обмена
  - "Избранное" - быстрый доступ к важным заметкам
- **Breadcrumb-навигация** - отображение полного пути к текущей заметке
- **Автоматическая организация** заметок из буфера по датам (ГГ.ММ.ДД → ЧЧ:ММ:СС)

### Rich-text редактор
- **Полное форматирование текста** с поддержкой HTML
- **Вставка изображений:**
  - Поддержка скриншотов (Print Screen)
  - Вставка файлов изображений
  - Копирование изображений из других приложений
  - HTML с base64 картинками (из Word, браузера)
- **Умная обработка изображений:**
  - Хранение в SQLite базе данных
  - Внутренние ссылки `noteimg://` для быстрого доступа
  - Экспорт в буфер обмена как base64 для совместимости с внешними приложениями
  - Редактирование изображений внешним редактором (F12)
- **Markdown просмотр** (F3) - отдельное окно для чтения заметки в режиме Markdown

### Буфер обмена
- **Автоматический мониторинг** всех изменений в буфере обмена
- **Умное определение контента:**
  - Чистый текст
  - Изображения (скриншоты, файлы)
  - Форматированный текст с картинками (из Word, браузера)
  - HTML контент с base64 изображениями
- **Защита от дубликатов** - не сохраняет одинаковые записи подряд
- **Специальный режим для заметок буфера:**
  - Read-only режим (защита от случайного редактирования)
  - **Enter** копирует всё содержимое заметки, сворачивает приложение и вставляет в активное окно (Ctrl+V)
- **Автоматическое именование** заметок по первой строке текста или параметрам изображения

### Навигация и управление

#### Глобальные горячие клавиши
- **Alt+S** - показать/активировать окно или переключить ветки (Текущие ↔ Буфер обмена ↔ Избранное)
- **Esc** - свернуть в системный трей
- **Shift+Esc** - выход из приложения

#### Локальные горячие клавиши

**Основные команды:**
- **F4** - создать новую заметку
- **F5** - добавить в избранное
- **F6** - переместить заметку
- **F8** - удалить заметку
- **F2** - переименовать заметку
- **Alt+D** - история изменений (недавно измененные заметки)
- **Ctrl+,** - настройки приложения

**Редактирование:**
- **Alt+W** - переключение фокуса между деревом и редактором
- **F3** - просмотр Markdown в отдельном окне
- **F12** - редактировать изображение в внешнем редакторе
- **Ctrl+F** - поиск в текущей заметке
- **Ctrl+Shift+F** - глобальный поиск по всей базе
- **Ctrl+C** - копировать всё содержимое заметки (если нет выделения)

**Навигация по дереву из редактора:**
- **Alt+↑/↓** - перемещение вверх/вниз
- **Alt+←/→** - свернуть/развернуть ветку
- **Alt+PgUp/PgDown** - постраничная навигация

**Темы:**
- **F10** - переключение между светлой и тёмной темой

### Поиск
- **Локальный поиск (Ctrl+F)** - поиск и подсветка в текущей заметке с навигацией по совпадениям
- **Глобальный поиск (Ctrl+Shift+F)** - поиск по заголовкам и содержимому всех заметок с превью результатов

### Хранение данных
- **SQLite база данных** с поддержкой транзакций
- **Автоматическое сохранение:**
  - При переключении между заметками
  - При потере фокуса редактором
  - При сворачивании окна
  - При выходе из приложения
- **Сохранение позиции курсора** для каждой заметки
- **Каскадное удаление** - при удалении родительской заметки удаляются все дочерние
- **Хранение изображений как BLOB** с метаданными (имя, MIME-тип)
- **Таблица состояния** - сохранение последней открытой заметки, геометрии окна, позиции сплиттера

### Интерфейс
- **Системный трей** с меню для быстрого доступа
- **Сохранение геометрии окна** - размер, позиция, состояние (развернуто/свернуто)
- **Настраиваемый сплиттер** между деревом и редактором
- **Строка статуса** с путём к текущей заметке
- **Breadcrumb панель** над редактором
- **Две темы:** светлая и тёмная с полной стилизацией всех элементов

### История и избранное
- **История изменений (Alt+D):**
  - Отслеживание всех изменений заметок по времени
  - Быстрый переход к недавно редактированным заметкам
  - Возможность очистки истории
- **Избранное (F5):**
  - Перемещение важных заметок в отдельную корневую ветку
  - Быстрый доступ через Alt+S

## Установка

### Требования
- Python 3.10+
- PySide6

### Установка зависимостей

```bash
pip install -r requirements.txt
```

### Запуск приложения

```bash
python app.py
```

## Конфигурация

Настройки хранятся в файле `config.json`:

```json
{
  "database_path": "notes.db",          // Путь к базе данных
  "font_family": "JetBrains Mono",      // Шрифт редактора
  "font_size": 13,                       // Размер шрифта
  "theme": "dark",                       // Тема: "light" или "dark"
  "image_editor_path": "path/to/editor.exe",  // Путь к редактору изображений
  "hotkeys": {
    "global": {
      "show_window": "<alt>+s"           // Глобальные горячие клавиши
    },
    "local": {
      // Настройка локальных горячих клавиш
      "toggle_focus": "Alt+W",
      "add_note": "F4",
      "delete_note": "F8",
      // ... остальные клавиши
    }
  }
}
```

### Настройка горячих клавиш

Все горячие клавиши настраиваются через файл `config.json` в секции `hotkeys.local`. Поддерживаемые модификаторы: `Ctrl`, `Alt`, `Shift`, функциональные клавиши `F1-F12`, специальные клавиши `PgUp`, `PgDown`, стрелки и т.д.

### Настройка редактора изображений

Для возможности редактирования изображений по F12 укажите путь к редактору в `image_editor_path`:
- **Windows:** `"c:\\Program Files\\Paint.NET\\PaintDotNet.exe"`
- **Linux:** `"/usr/bin/gimp"`
- **Mac:** `"/Applications/Preview.app/Contents/MacOS/Preview"`

## Архитектура

### Структура проекта

```
mvp/
├── app.py                    # Точка входа
├── config.json              # Конфигурация
├── requirements.txt         # Зависимости
├── core/
│   ├── repository.py        # Работа с SQLite базой
│   ├── main_window.py       # Главное окно приложения
│   ├── note_editor.py       # Rich-text редактор с поддержкой изображений
│   ├── clipboard_monitor.py # Мониторинг буфера обмена
│   ├── hotkey_controller.py # Глобальные горячие клавиши (Win/Linux)
│   ├── tray_controller.py   # Системный трей
│   ├── theme_manager.py     # Управление темами
│   ├── config.py           # Загрузка/сохранение конфигурации
│   └── ui/                 # UI компоненты и миксины
│       ├── mixins/         # Разделение функциональности главного окна
│       ├── settings_dialog.py
│       ├── history_dialog.py
│       ├── search_widget.py
│       ├── global_search_dialog.py
│       ├── markdown_view_dialog.py
│       └── image_selection_dialog.py
```

### Основные компоненты

- **NoteRepository** - слой доступа к данным (SQLite)
- **MainWindow** - главное окно с деревом и редактором (использует миксины для разделения ответственности)
- **NoteEditor** - кастомный QTextEdit с поддержкой вставки изображений и специальной обработки буфера обмена
- **ClipboardMonitor** - фоновый мониторинг изменений буфера с умной дедупликацией
- **HotkeyController** - регистрация и обработка глобальных горячих клавиш через native API (Win32/X11)
- **ThemeManager** - применение QSS стилей для светлой/тёмной темы

### Миксины главного окна

- **WindowStateMixin** - сохранение/восстановление геометрии окна
- **EditorStyleMixin** - применение шрифтов и стилей к редактору
- **TreeNavigationMixin** - навигация по дереву с клавиатуры
- **EditorStorageMixin** - сохранение содержимого редактора
- **TreeDataMixin** - загрузка и управление данными дерева
- **NoteActionMixin** - операции с заметками (создание, удаление, перемещение)
- **BranchControlMixin** - переключение между ветками (Текущие/Буфер/Избранное)

## База данных

### Схема

**notes** - основная таблица заметок
- `id` - уникальный идентификатор
- `parent_id` - ссылка на родительскую заметку (NULL для корневых)
- `title` - заголовок заметки (однострочный)
- `body_html` - содержимое в формате HTML
- `cursor_position` - сохраненная позиция курсора
- `updated_at` - время последнего изменения

**attachments** - вложения (изображения)
- `id` - уникальный идентификатор
- `note_id` - ссылка на заметку
- `kind` - тип вложения ("image")
- `name` - имя файла
- `bytes` - бинарные данные (BLOB)
- `mime` - MIME-тип (image/png, image/jpeg и т.д.)

**state** - состояние приложения
- `key` - ключ (например, "last_opened_note_id")
- `value` - значение

### Особенности

- **Foreign keys** включены (`PRAGMA foreign_keys = ON`)
- **Каскадное удаление** (`ON DELETE CASCADE`) - при удалении заметки автоматически удаляются все дочерние заметки и вложения
- **Ленивая загрузка изображений** - картинки загружаются из БД только при отображении через `loadResource()`
- **VACUUM** - поддержка сжатия базы для освобождения места

## Сборка исполняемого файла

Для создания standalone приложения используется PyInstaller:

```bash
pip install pyinstaller
pyinstaller --onefile --windowed --icon=app_icon.ico --name="NotesManager" app.py
```

Параметры:
- `--onefile` - один исполняемый файл
- `--windowed` - без консольного окна
- `--icon` - иконка приложения
- `--name` - имя выходного файла

## Платформы

- **Windows** - полная поддержка (глобальные горячие клавиши через Win32 API)
- **Linux** - полная поддержка (глобальные горячие клавиши через X11)
- **macOS** - базовая поддержка (глобальные горячие клавиши требуют дополнительной настройки)

## Лицензия

MIT License - см. файл [LICENSE](LICENSE)

## Разработка

### Добавление новых возможностей

1. **Новая операция с заметкой** - добавьте метод в `NoteActionMixin`
2. **Новая навигация** - добавьте в `TreeNavigationMixin`
3. **Новый UI элемент** - создайте диалог в `core/ui/`
4. **Изменение схемы БД** - добавьте миграцию в `NoteRepository._init_db()`

### Отладка

Для отладки глобальных горячих клавиш и событий буфера обмена используйте print-отладку или логирование:

```python
import logging
logging.basicConfig(level=logging.DEBUG)
```

## Известные проблемы и ограничения

- Глобальные горячие клавиши на macOS требуют специальных разрешений
- Большие изображения (>10MB) могут замедлять работу при первой загрузке
- HTML форматирование ограничено возможностями Qt Rich Text
- Markdown просмотр - базовый рендеринг без расширенного синтаксиса

## Roadmap

- [ ] Экспорт заметок в Markdown/HTML
- [ ] Импорт из других форматов
- [ ] Теги и метки для заметок
- [ ] Full-text поиск с индексированием
- [ ] Синхронизация между устройствами
- [ ] Плагины и расширения
- [ ] Шифрование чувствительных заметок
